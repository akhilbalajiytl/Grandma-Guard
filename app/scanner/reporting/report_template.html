<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Grandma Guard Safety Scan Report: {{ scan_name }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');

        :root {
            --brand-dark-teal: #1E2A2B;
            --brand-teal: #3A6B6F;
            --brand-plum: #8B5A8C;
            --brand-orange: #F2A444;
            --brand-cream: #F5E8D7;

            --text-color: var(--brand-cream);
            --text-muted: #a0a0a0;
            --panel-bg: #2a3a3b;
            --border-color: #4a5a5b;
            --hover-bg: #3a4a4b;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--brand-dark-teal);
            color: var(--text-color);
            margin: 0;
            /* Subtle fabric texture for the "knitted" feel */
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%232a3a3b' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* --- Common Header --- */
        .header-nav {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--panel-bg);
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .header-nav .logo {
            height: 50px;
            margin-right: 1rem;
        }

        .header-nav .brand-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-right: auto;
            /* Pushes nav links to the right */
        }

        .header-nav .brand-title small {
            display: block;
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--text-muted);
        }

        .header-nav .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .header-nav .nav-links a:hover {
            background-color: var(--hover-bg);
        }

        /* --- General Element Styling --- */
        h1,
        h2,
        h3 {
            color: white;
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5em;
        }

        .card {
            background-color: var(--panel-bg);
            padding: 1.5em;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--panel-bg);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        th,
        td {
            padding: 1em;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--brand-dark-teal);
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            background-color: var(--brand-dark-teal);
            padding: 1em;
            border-radius: 8px;
            font-size: 0.9em;
            border: 1px solid var(--border-color);
        }

        button,
        .btn {
            background-color: var(--brand-orange);
            color: var(--brand-dark-teal);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        button:hover,
        .btn:hover {
            background-color: #ffbe6d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        input,
        select {
            background-color: var(--brand-dark-teal);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Nunito', sans-serif;
        }
    </style>
</head>

<body>

    <header class="header-nav">
        <!-- We can't use url_for here. Embed the logo as a base64 string or link to a public URL. -->
        <!-- For simplicity, we'll just show the title. -->
        <div class="brand-title">Grandma Guard<small>Knitting a safety blanket around your AI</small></div>
    </header>

    <div style="padding: 0 2rem;">
        <h1>Grandma Guard Scan Report</h1>
        <p class="subtitle">Test Name: <strong>{{ scan_name }}</strong></p>
        <p class="subtitle">Model Under Test: <strong>{{ model_identifier }}</strong></p>
        <p class="subtitle">Scan Timestamp: <strong>{{ timestamp }}</strong></p>
    </div>

    <div class="summary-grid">
        <div class="summary-card score">
            <div class="label">Overall Score</div>
            <div class="value">{{ "%.1f"|format(overall_score * 100) }}%</div>
        </div>
        <div class="summary-card passed">
            <div class="label">Passed</div>
            <div class="value">{{ passed_count }}</div>
        </div>
        <div class="summary-card failed">
            <div class="label">Failed (Vulnerable)</div>
            <div class="value">{{ failed_count }}</div>
        </div>
        <div class="summary-card pending">
            <div class="label">Pending Review</div>
            <div class="value">{{ pending_count }}</div>
        </div>
    </div>

    <h2>Results by Category</h2>
    <div class="chart-container">
        <canvas id="owasp-chart"></canvas>
    </div>

    <h2>Detailed Results</h2>
    <table>
        <thead>
            <tr>
                <th>Category</th>
                <th>Status</th>
                <th>Payload</th>
                <th>Model Response</th>
            </tr>
        </thead>
        <tbody>
            {% for result in results %}
            <tr>
                <td>{{ result.owasp_category }}</td>
                <td><span class="status status-{{ result.status }}">{{ result.status.replace('_', ' ') }}</span></td>
                <td>
                    <pre>{{ result.payload }}</pre>
                </td>
                <td>
                    <pre>{{ result.response }}</pre>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <footer>
        Report generated by LLM Safety Toolkit
    </footer>

    <!--JavaScript to render the chart-->
    <script>
        const ctx = document.getElementById('owasp-chart').getContext('2d');

        // Use the 'tojson' filter to safely embed the data from our Python script.
        // The 'safe' filter prevents Jinja2 from HTML-escaping the JSON string.
        const chartData = {{ chart_data | tojson | safe }};

        new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    title: {
                        display: false, // Title is already in the H2 tag
                    },
                    legend: {
                        position: 'top',
                    },
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            // Ensure y-axis ticks are integers
                            precision: 0
                        }
                    }
                }
            }
        });
    </script>
</body>

</html>